

# 网络层概述

### 1. 位置

![位置](./图片/第4章/位置.png)

### 2. 分层理解(好处)

学习某一层协议的时候, 希望屏蔽掉其它层的细节, 不关心物理层是如何进行信号的传输的, 也不关心数据链路层如何封装成帧, 进行差错检错的, 重点关注网络层做了哪些工作, 和其它层有哪些不一样的地方. 

![屏蔽掉细节](./图片/第4章/屏蔽掉细节.png)

从图中可以看到, A通过路由器传送数据到 B三个设备都使用了网络层, 在路由器中使用的协议就是网络层(路由器并不会使用传输层, 也不会使用应用层, 路由器使用的是最上层的协议. 

### 3. 网络层作用

网络层解决的问题是数据路由的问题, 决定数据在网络中的路径. 也就是数据如何从发送计算机达到目的计算机. 

### 4. 上一章的问题

A向 C发送数据, 因为只能是相邻物理节点传输, A只能发送数据给 D, F, A该如何跨设备传输数据到 C

![更为复杂的传输](./图片/第4章/更为复杂的传输.png)

将问题再放大, 在下图的网络拓扑里面, A将数据传输到 B, 该如何做呢? 

![需要解决的问题](./图片/第4章/需要解决的问题.png)



先了解下面的内容, 再来解决问题

### 5. 路由器

路由器是网络层重要的设备

#### 作用(百度百科)

路由器是连接两个或多个网络的硬件设备，在网络间起网关的作用，是读取每一个数据包中的地址然后决定如何传送的专用智能性的网络设备。

它能够理解不同的协议，

1. 例如某个局域网使用的以太网协议，
2. 因特网使用的TCP/IP协议。这样，路由器可以分析各种不同类型网络传来的数据包的目的地址，把非TCP/IP网络的地址转换成TCP/IP地址，或者反之；再根据选定的路由算法把各数据包按最佳路线传送到指定位置。所以路由器可以把非TCP/ IP网络连接到因特网上。

#### 种类

从硬件的角度区分, 可以分为家庭路由器和企业路由器, 功能和构造都是相同的. 只不过是性能不一样而已. 

![路由器种类](./图片/第4章/路由器种类.png)

##### 一句话总结

路由器能够识别各种协议, 实现数据的转发



# IP协议

## 1. 虚拟互联网络

### 问题

计算机 A将数据传输到计算机 B, 该如何做呢?

![需要解决的问题](./图片/第4章/需要解决的问题.png)

有很多的路径可以将数据从 A传到 B. 

![使用路径](./图片/第4章/使用路径.png)

对于如何连接, 使用哪种路径, 数据报如何发送, 使用者是并不关心的. 是有网络层所解决的. 

### 虚拟互联网络

#### a. 是什么

* 实际的计算机网络是错综复杂的. 物理网络可能连接不同的家庭, 地区, 城市, 国家等. 

* 物理设备通过使用 IP协议, 屏蔽了物理网络之间的差异. 

* 当网络中的主机使用 IP协议连接时, 则无需关注网络细节. 

* 使用 IP协议时, 关注端到端的连接.  

对于上图的网络拓扑, 可以看做是虚拟的互联网络

![虚拟互联网络](./图片/第4章/虚拟互联网络.png)

#### b. 理解

1. A只需要将数据发送到虚拟互联网络里面, 
2. 虚拟互联网络可以解决传输问题. 
3. 并且准确的传送到 B中去. 

这是 IP层或者网络层提出的一个重要的概念. 



## 2. IP协议

### 1. IP协议作用

1. IP协议使得复杂的实际网络变为一个虚拟互联网络.

   > 只需要将终端设备连接到虚拟互联网络中就可以了, 并不需要关系内部的结构

2. IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发

   > 不需要关心数据是经过了无线 wife, 或者海底电缆等过程

3. IP协议解决了在虚拟网络中数据报传输路径的问题

   > IP协议向上提供了虚拟互联网络, 在底层解决了路径传输的问题. 

##### 一句话总结

IP协议的作用就是将复杂的实际网络变为虚拟互联网络

### 2. IP地址与 MAC地址

#### 相同

IP地址在网络层中的功能和 MAC地址在数据链路层的功能是类似的. IP地址是网络设备唯一的一个身份, 每个网络设备都拥有一个唯一的网络地址. 可以唯一标识. 

#### 区别

* MAC地址是唯一的, 不可改变的. 

  > 网卡从一个地方移动到另一个地方, 从我的计算机拆下来放到你的计算机上. MAC地址是不变的

* IP地址对于网络设备来说是可变的, 受网络环境所影响. 

  > 笔记本电脑在家里面连接 wife的时候是这个 IP地址. 但是把电脑拿到图书馆, IP地址将会发生变化. 

### 3. IP地址表示

#### 表示方式

* IP地址长度为 32位, 常分成 4个 8位

* IP地址常使用点分十进制来表示 (`0~255.0~255.0~255.0~255`)

  举例

  ![IP地址](./图片/第4章/IP地址.png)

* 使用 32为最多可以表示 2^32个地址 = 4294961296 (约42亿)

#### 位置

![处于的位置](./图片/第4章/处于的位置.png)

### 4. IP数据报首部

#### a. 首部格式

![IP首部的具体格式](./图片/第4章/IP首部的具体格式.png)

**注意:** 每行都是 32个bit, 一共 4个字节. IP首部至少有 20个字节的长度. (五行必须有, 选项一行可以没有, IP数据可以没有, 5 * 4)

#### b. 理解

##### 第一行

* **版本:** 占 4位, 指的是 IP协议的版本, 通信双方的版本必须一致, 当前主流版本是 4, 及 IPv4, 也有 IPv6

* **首部长度:** 占 4位, 最大数值为 15, 表示的是 IP首部长度, 单位是 “32位字” (4个字节), 也即是 IP首部最大长度为 60字节 (15 * 4, 包括选项 options)

* **服务类型:** 占 8位, 一般不需要关心.

* **总长度:** 占16位, 最大数值为 65535, 表示的是 IP数据报总长度 (IP首部 + IP数据)

  > 这个长度是 比 MTU高的, 如果传输的时候 IP数据报的长度 > MTU, 数据链路层将会把 IP数据报进行切片

##### 第二行

* **标识:** 协议内部具体使用的. 一般不关心. 
* **标志:** 占3位, 只有 2位是有意义的. IP报文是否可以进行分片
* **片偏移:** IP数据报文的长度比 MTU要长的话. 将会进行 IP报文的分片, 使用片偏移记录当前的数据帧保存的是第几个偏移的 IP数据. 

##### 第三行

* **TTL:** 占 8位, 表示 IP数据报文在网络中的寿命, 每经过一个设备, TTL减 1, 当 TTL = 0时, 网络设备必须丢弃该报文

  > 解决的是 IP报文在网络中找不到终点的时候避免 IP数据在网络中无效的进行传输, 消耗带宽

* **8位协议:** 占 8位, 表明 IP数据所携带的具体数据是什么协议(如: TCP, UDP等)

  > ![协议种类](./图片/第4章/协议种类.png)

* **首部校验和:** 占 16位, 校验 IP首部是否有差错

  > 接收方在接受了 IP协议的报文之后, 会进行头部的校验. 如果有错误, 直接丢弃掉


##### 第四行, 第五行

- **源IP地址:** 发送 IP数据报的 IP地址
- **目的 IP地址:** IP数据报到达位置的 IP地址



### 5. IP协议的转发流程

了解的 IP协议的首部, 那如何使用 IP协议呢? 

#### a. IP报文的传输过程

计算机 A发送 IP报文, 经过网络 1, 之后到达 路由器 1, .... 最终到达计算机 B

![协议转发](./图片/第4章/协议转发.png)

**逐跳(hop-by-hop):** 数据报文从计算机 A一跳一跳的来到 计算机 B的(比较形象)

那是如何实现上述转发的呢? 先来了解什么是路由表. 

#### b. 路由表简介

路由表和 MAC地址表类似. 路由表工作在网络层. 属于 IP协议. 

计算机和路由器都拥有路由表

##### 与 MAC表对比

![MAC表与路由表对比](./图片/第4章/MAC表与路由表对比.png)

###### 区别

* MAC表: 通过 MAC地址找到硬件接口

* 路由表: 通过 目的 IP地址找到下一跳 IP地址

#### c. 流程

![之前的问题](./图片/第4章/之前的问题.png)

##### 步骤

1. A发出目的地为 C的 IP数据报，**查询路由表发现下一跳为 E**
2. A将数据报发送给 E
3. E**查询路由表发现下一跳为 F**,将数据报发送给 F
4. F**查询路由表发现与目的地 C直接连接**，将数据报发送给 C

那路由器连接那么多的设备, 是如何找到下一跳的是哪个设备呢, 在路由器的讲解中有答案(图的算法)? 

#### d. 整个过程

结合数据链路层进行理解

![转发流程理解](./图片/第4章/转发流程理解.png)

##### 如图

![之前的问题](./图片/第4章/之前的问题.png)

- 第一步

  - A发出目的地为 C的IP数据报,**查询路由表发现下一跳为E**

  - A将 IP数据报**交给数据链路层，并告知目的MAC地址是E**

    > 如何根据 下一跳 IP找到MAC地址的, 是 ARP协议完成的
    >
    > 通过下一跳的 IP, 使用 ARP缓存表找到 IP对应的 MAC地址

  - 数据链路层**填充源MAC地址A和目的MAC地址E** (以太网协议填充首部信息)

    > 知道了目的接口的 MAC地址, 通过 MAC表找到对应的接口, 然后从路由器的特定接口发送数据

  - 数据链路层通过物理层将数据发送给E

- 第二步
  - E的数据链路层接收到数据帧,**把帧数据交给网络层** (将上一个以太网的首部拆掉了)
  - E**查询路由表，发现下一跳为F**
  - E**把数据报交给数据链路层，并告知目的MAC地址为F**
  - E的数据链路层**封装数据帧并发送,** 这里面的封装数据帧会填充源 MAC地址为 E和目的 MAC地址为 F.
- 第三步
  - F的数据链路层接收到数据帧，**把帧数据交给网络层**
  - F**查询路由表，发现下一跳为C**
  - F**把数据报交给数据链路层**，并**告知目的MAC地址为C**
  - F的数据链路层**封装数据帧并发送** 

##### 注意

- 数据帧每一跳的 MAC地址都在进行变换(对以太网的首部信息进行重新赋值)
- IP数据报每一条的 IP地址都是不变的(IP报文的首部信息没有被重写过)



# ARP协议与 RARP协议

## 问题引入

对于之前的内容 A将 IP数据报**交给数据链路层，并告知目的MAC地址是E**

A是如何知道 E的MAC地址的呢?

ARP协议来解决这个问题

## ARP协议

### 协议作用

* ARP(Address Resolution Protocal): 地址解析协议

* 把网络层的 IP 32位地址转换为 数据链路层 MAC 48位地址

  ![ARP作用](./图片/第4章/ARP作用.png)

### ARP缓存表

#### a. 作用

包括 IP地址和对应的MAC地址

![ARP缓存表](./图片/第4章/ARP缓存表.png)

##### 一句话总结

通过 IP地址找到对应的 MAC地址

#### b. 使用

* 如果ARP缓存表缓存有 IP地址和 MAC地址的映射关系

  > A可以直接告诉数据链路层目的地址的地址

* 如果ARP缓存表缓存没有 IP地址和 MAC地址的映射关系

  * ARP将会广播某一个 IP的信息
  * 收到广播后的所有设备将会回应一个包. 表示我是不是这个 IP地址
  * 如果是将会记录这个 IP地址和 MAC地址

#### c. 注意

* ARP缓存表是 ARP协议和 RARP协议运行的关键. 

* ARP缓存了 IP地址到硬件地址之间的映射关系

* ARP缓存表中的记录并不是永久有效的, 有一定的期限

  > 因为 MAC地址是不会改变的, 但是 IP地址会变化, 对于IP地址到 MAC地址的映射并不是唯一的映射, 会随着 IP地址的变化而变化

#### d. 查看 ARP缓存表

使用命令 `arp -a`

![查看arp协议](./图片/第4章/查看arp协议.png)

### ARP协议

#### 概念

0806是 ARP协议的请求或者应答

ARP协议是直接封装在数据帧的, 那么为什么 ARP协议是属于网络层的内容呢?

因为 ARP协议使用到了 IP地址, ARP协议是网络层和数据链路层配合使用的一个重要的协议

![ARP协议构成](./图片/第4章/ARP协议构成.png)

#### 解决问题

A将 IP数据报**交给数据链路层，并告知目的MAC地址是E** 的过程为: 

1. A先查询了 ARP的缓存表, 通过 IP数据报中的 目的 IP地址匹配到了所对应的 MAC地址
2. 有根据 MAC地址通过路由表找到了对应的硬件接口, 然后通过硬件接口进行了数据发送

## RARP

#### 是什么

* RARP(Reverse Address Resolution Protocol): 逆地址解析协议

* 是 ARP协议的逆过程, 将 MAC地址转为 IP地址

  ![RARP作用](./图片/第4章/RARP作用.png)







# IP地址的子网划分

## 1. 子网划分

#### 什么是子网划分

对 IP地址的规划

#### 为什么进行子网划分

之前学过共有 42亿个 IP地址, 如果不对其进行规划. 没有很合理的分配方式, 直接对IP地址进行分配的话. 规划和分配时非常麻烦的. 因此要对 IP地址进行规划

## 2. 分类的 IP地址

### 类别

对 IP地址进一步的规划, 分成两个部分, 网络号和主机号, 共 32位

![IP地址的分类](./图片/第4章/IP地址的分类.png)

* 网络号代表属于哪一个网段

* 主机号代表在这个网段里面的序号

#### 分类后的信息

![分类后的数量](./图片/第4章/分类后的数量.png)

#### 特殊的主机号

* 主机号全0表示当前网络段，不可分配为特定主机
* 主机号为全1表示广播地址,向当前网络段所有主机发消息

###### 举例

![特殊主机号](./图片/第4章/特殊主机号.png)

#### 特殊的网络号

* A类地址网络段全0(00000000)表示特殊网络
* A类地址网络段后7位全1(0111111:127)表示回环地址
* B类地址网络段(10000000.00000000:128.0)是不可使用的
* C类地址网络段(192.0.0)是不可使用的

#### 更精确的分类信息

![更精确的分类](./图片/第4章/更精确的分类.png)

D类和E类通常用于特殊的用途

#### 习题

判断该 IP地址是哪一类 IP地址

解题: 看首 8位进行判断

|      IP       | 首 8位的二进制 | 类别 |
| :-----------: | :------------: | :--: |
| 125.125.3.60  |    01111101    | A类  |
| 163.70.31.23  |    10100011    | B类  |
| 210.36.127.11 |    11010010    | C类  |

巧记(十进制):

* A类: 0 - 126

* B类: 128 - 191

* C类: 192 - 223

* D类: 224 - 239

* E类: 240 - 255

#### 回环地址

127.0.0.1,通常被称为本地回环地址(Loopback Address),不属于任何-个有类别地址类。

它代表设备的本地虚拟接口，所以默认被看作是永远不会宕掉的接口。在Windows操作系统中也有相似的定义，所以通常在安装网卡前就可以ping通这个本地回环地址。一般都会用来检查本地网络协议、基本数据接口等是否正常的。

## 划分子网

### 问题

#### 题目一

某个公司拥有 100名员工, 每人配备一个计算机, 请问该公司应该申请哪种网络段. 

![子网划分](./图片/第4章/子网划分.png)

**答:** 通过表格可知, 应该申请 C类的. 假设申请 193.10.10.0, 这个网段的, 共有 254个, 使用了 100个

#### 题目二

假设有 256个员工, , 每人配备一个计算机, 请问该公司应该申请哪种网络段.

**答:** A类是不够的, 需要分配 B类地址

##### 问题

但是造成了很大的地址空间浪费, 如果都这样, IP地址很快就会被用完. 

##### 解决

因此在分类的 IP地址之上又提出了子网划分的概念.

### 子网划分

#### 什么是子网划分

划分子网的时候将 IP地址划分为三个部分. 

![子网划分2](./图片/第4章/子网划分2.png)

通过例子来看什么是子网划分

#### 例子

把原来的 C类地址划分为两个子网

![子网划分例子](./图片/第4章/子网划分例子.png)

这样划分就将以前的 255个有缩减了一半, 这样就可以节省 IP地址

将刚才的子网分给刚才的公司, 这样也可以满足需求, 浪费了26个 IP, 节省了大量 IP

#### 问题

如果 A, B, C类都进行子网划分, 则会导致会形成很多的子网. 那怎么判断某个 IP是属于哪个网络号的呢?

### 子网掩码

**通过子网掩码, 就可以快速的判断出属于哪个网络号**

* 子网掩码和 IP地址一样, 都是 32位. 
* 子网掩码是由连续的 1和连续的 0组成的.
* 某一个子网的子网掩码具有网络号位数个连续的 1组成的

#### 按网络类别进行划分

![子网掩码](./图片/第4章/子网掩码.png)

#### 子网划分的子网掩码

![子网掩码举例2](./图片/第4章/子网掩码举例2.png)

#### 如何进行判断

如何快速的得到 IP的网络号

##### 例一

![求网络号1](./图片/第4章/求网络号1.png)

**步骤**

1. IP和子网掩码是已知的, 求出两者的二进制编码
2. 进行 &运算, 再将得到的值转换为十进制
3. 得到 IP的网络号

## 无分类编址 CIDR

#### 出现

子网划分太复杂了. 希望有更好, 更简便的方法使用 IP地址, 因此提出 CIDR的概念

* CIDR中没有 A, B, C类网络号, 和子网划分的概念

* CIDR将**网络前缀**相同的 IP成为一个 **“CIDR地址块“**

  ![CDIR划分](./图片/第4章/CDIR划分.png)

  > 网络前缀是任意位数, 并不受限于某一类 IP地址

#### 斜线记法

| 记法             | 意义                              |
| ---------------- | --------------------------------- |
| 193.10.10.129/25 | 表示网络前缀有 25位, 主机号有 7位 |

常见 CIDR长度

![斜线记法](./图片/第4章/斜线记法.png)

**优势:** 网络前缀比原来的子网划分更加灵活

#### 之前的问题

在 IP后面加 /25就可以了

193.10.10.0/25

#### 问题升级

假设又增加了 100名员工,并拆分成两个部门, 如何进行规划?

如图

![升级题目答案](./图片/第4章/升级题目答案.png)

#### 问题再升级

对于城市进行 CIDR规划

如图

![对城市进行CIDR规划](./图片/第4章/对城市进行CIDR规划.png)



# 网络地址转换 NAT技术

### 出现原因

为什么需要使用 NAT技术, 因为 IP地址不够用了

* IPV4最多只有 40+亿个
* 早期 IP地址的不合理规划导致 IP号浪费

### 实际情况

实际情况下家庭只有一个外网地址, 公司内部 IP也不够支持所有的计算机, 那是如何进行通信的呢

###### 图一

![边缘部分1](./图片/第4章/边缘部分1.png)

###### 图二

![边缘部分2](./图片/第4章/边缘部分2.png)

### IP地址分类

* **内网地址:** 内部机构所使用的, 避免与外网地址重复

  * 10.0.0.0 ~ 10.255.255.255 (支持千万数量级设备)
  * 172.16.0.0 ~ 172.31.255.255 (支持百万数量级设备)
  * 192.168.0.0 ~ 192.168.255.255 (支持万级数量级设备)

  > 因为内网地址主要是给内部机构所使用的, 因此 A公司和 B公司可以使用一样的内网地址, 并不会影响冲突

* **外网地址:** 全球范围使用, 全球公网唯一

### 问题解决

###### 图一

![解决 IP不够用的问题2](./图片/第4章/解决 IP不够用的问题1.png)

###### 图二

![解决 IP不够用的问题](./图片/第4章/解决 IP不够用的问题2.png)

### 新的问题

但是这样又会引发新的问题, 内网多个设备使用同一个外网 IP请求外网的服务, 外部怎么知道具体是哪个设备在请求的?

需要使用 NAT技术来解决

### NAT

#### 原理

* 网络地址转换 NAT (Network Address Translation)
* NAT技术用于多个主机通过一个公有 IP访问互联网的私有网络中
* NAT交换了 IP地址的消耗, 但是增加了网络通信的复杂度

#### 例子

![NAT的使用](./图片/第4章/NAT的使用.png)

###### 原理

1. 在本地的路由器进行的, 将内网的地址和端口号转换为新的地址和端口号对外进行通信
2. 并且在接收到相关的数据之后, 再把外网地址+端口号映射为内网的地址+端口号 



# ICMP协议

* 网际控制报文协议 (Internet Control Message Protocol)

* ICMP协议可以报告错误信息或者异常情况

  > 主要是辅助 IP协议, 使得 IP协议可以更好的传输数据

#### 位置

![ICMP位置](./图片/第4章/ICMP位置.png)

#### ICMP报文首部

![ICMP报文首部](./图片/第4章/ICMP报文首部.png)

* **8位类型:** ICMP报文的种类
* **8位代码:** 不同的 ICMP报文种类的具体的哪一些错误
* **16位校验和:** 校验整个报文在传输过程中是否发生错误

#### 结合IP使用

![ICMP报文理解](./图片/第4章/ICMP报文理解.png)

如果 IP协议存入的是 1, 那么使用的协议为 ICMP协议

### ICMP报文类别

#### 差错报告报文

![差错报告报文](./图片/第4章/差错报告报文.png)

#### 询问报文

主要验证网络是不是通的

![询问报文](./图片/第4章/询问报文.png)



更多的时候是使用差错报告的功能

## ICMP协议的应用

没有弄太清楚

### Ping应用

 ping的数据共有 32个字节

可以使用 ping命令进行网络故障的排查. 

1. Ping回还地址 127.0.0.1

   > 如果得不到返回, 说明计算机的协议栈出现了问题, 要重装系统, 或者重新安装协议栈

2. ping网关地址

   > 计算机处于内网, 会 ping 192.168.0.1 或者 192.168.1.1 通常是路由器的地址

   1. 如果可以, 说明本机到路由器的通路是 ok的
   2. 如果不可以, 说明 wife或者网线连接是有问题的

3. ping 远端地址

   * 如果不通, 说明从家到 ISP之间是有故障的, 需要联系移动连通来解决

### Tranceroute 应用

探查 IP数据报在网络中走过的路径

计算机是连接在一个虚拟互联网里面的. 并不关心 IP数据报在网络中走过了哪些路径. 但是需要对网络故障进行排查的话. 这个应用将可以提供更高级的功能. 使得我们更了解我们的网络是怎么样的. 



**TTL:** 占 8位, 表明 IP数据报文在网络中的寿命, 没经过一个设备, TTL减 1, 当 TTL = 0时, 网络设备必须丢弃该报文

当不可到达的时候 ICMP终点不可达差错报文. 才会让源主机查询到不同

 ![tracert输出](./图片/第4章/tracert输出.png)



# 路由

### 问题

之前讲的路由的下一跳的地址是怎么来的?

下一跳的地址是唯一的吗

下一跳的地址是最佳的吗?

路由器这么多, 他们是怎么协同工作的? 

### 路由算法的本质

需要一个好的算法来进行解决

将网络转换为图

![图论](./图片/第4章/图论.png)

* 每一个顶点表示一个网络, 路由器或计算机
* 每一条边表示一条网络路径
* 从一个顶点到达另一个地方是有多条路径的

**路由算法实际上是图论的算法, 但路由算法要比图论的算法要复杂**

> 互联网网络环境复杂, 网络发生抖动, 发生变化

#### 对算法的要求(理想)

* 算法是**正确的, 完整的**

* 算法在计算上应该尽可能的**简单**
* 算法可以**适应网络中的变化**
* 算法是**稳定的**和**公平的**



因为互联网的规模是非常大的并且互联网环境是非常复杂的, 所以要**对互联网进行划分**

### 自制系统 (Autonomous System)

* 一个自制系统(AS)是处于一个管理机构下的网络设备群

* AS内部网络自行管理, AS对外提供一个或者多个出(入)口

#### 分类

* 自治系统内部路由的协议称为: 内部网关协议 (RIP, OSPF)

* 自治系统外部路由的协议称为: 外部网关协议 (BGP)

![网关协议](./图片/第4章/网关协议.png)

AS1是公司的网络, AS2是校园的网络

 

